<!DOCTYPE html><html lang="en-us" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="James E. Pustejovsky">

  
  
  
    
  
  <meta name="description" content="\[\def\Pr{{\text{Pr}}}\def\E{{\text{E}}}\def\Var{{\text{Var}}}\def\Cov{{\text{Cov}}}\def\bm{\mathbf}\def\bs{\boldsymbol}\]
For a project I am working on, we are using Stan to fit generalized random effects location-scale models to a bunch of count data.">

  
  <link rel="alternate" hreflang="en-us" href="https://www.jepusto.com/generalized-poisson-in-stan/">

  


  
  
  
  <meta name="theme-color" content="#3f51b5">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png">

  <link rel="canonical" href="https://www.jepusto.com/generalized-poisson-in-stan/">

  
  
  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@jepusto">
  <meta property="twitter:creator" content="@jepusto">
  
  <meta property="og:site_name" content="James E. Pustejovsky">
  <meta property="og:url" content="https://www.jepusto.com/generalized-poisson-in-stan/">
  <meta property="og:title" content="Implementing Consul&#39;s generalized Poisson distribution in Stan | James E. Pustejovsky">
  <meta property="og:description" content="\[\def\Pr{{\text{Pr}}}\def\E{{\text{E}}}\def\Var{{\text{Var}}}\def\Cov{{\text{Cov}}}\def\bm{\mathbf}\def\bs{\boldsymbol}\]
For a project I am working on, we are using Stan to fit generalized random effects location-scale models to a bunch of count data."><meta property="og:image" content="https://www.jepusto.com/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png">
  <meta property="twitter:image" content="https://www.jepusto.com/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2023-12-06T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2023-12-06T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.jepusto.com/generalized-poisson-in-stan/"
  },
  "headline": "Implementing Consul's generalized Poisson distribution in Stan",
  
  "datePublished": "2023-12-06T00:00:00Z",
  "dateModified": "2023-12-06T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "James E. Pustejovsky"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "James E. Pustejovsky",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.jepusto.com/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "\\[\r\\def\\Pr{{\\text{Pr}}}\r\\def\\E{{\\text{E}}}\r\\def\\Var{{\\text{Var}}}\r\\def\\Cov{{\\text{Cov}}}\r\\def\\bm{\\mathbf}\r\\def\\bs{\\boldsymbol}\r\\]\nFor a project I am working on, we are using Stan to fit generalized random effects location-scale models to a bunch of count data."
}
</script>

  

  


  


  
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <link rel="stylesheet" href="/css/codefolding.css" />



  <title>Implementing Consul&#39;s generalized Poisson distribution in Stan | James E. Pustejovsky</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">James E. Pustejovsky</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">James E. Pustejovsky</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/files/Pustejovsky-CV.pdf"><span>CV</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#working-papers"><span>Working papers</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/publication/"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/talk/"><span>Presentations</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#software"><span>Software</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#people"><span>Students</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#teaching"><span>Teaching</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#tags"><span>Topics</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      

      

    </ul>

  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Implementing Consul&#39;s generalized Poisson distribution in Stan</h1>

  

  
    

<div id="code-folding-buttons" class="dropdown btn-group pull-right">
  <a class="btn btn-light btn-sm dropdown-toggle" href="#" role="button" id="allCodeToggleButton"
     data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Code
  </a>
  <div class="dropdown-menu" aria-labelledby="allCodeToggleButton">
    <a id="rmd-show-all-code" class="dropdown-item small" href="#">Show all</a>
    <a id="rmd-hide-all-code" class="dropdown-item small" href="#">Hide all</a>
  </div>
</div>



    


<div class="article-metadata">

  
  
  
  
  <div>
    

  
  <span><a href="/authors/admin/">James E. Pustejovsky</a></span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    2023-12-06
  </span>
  

  

  

  
  
  
  <span class="middot-divider"></span>
  <a href="/generalized-poisson-in-stan/#disqus_thread"></a>
  

  
  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style">
      


<p><span class="math display">\[
\def\Pr{{\text{Pr}}}
\def\E{{\text{E}}}
\def\Var{{\text{Var}}}
\def\Cov{{\text{Cov}}}
\def\bm{\mathbf}
\def\bs{\boldsymbol}
\]</span></p>
<p>For a project I am working on, we are using <a href="https://mc-stan.org/">Stan</a> to fit generalized random effects location-scale models to a bunch of count data.
In <a href="/double-poisson-in-Stan/">a previous post</a>, I walked through our implementation of <a href="https://doi.org/10.2307/2289002">Efron’s (1986)</a> double-Poisson distribution, which we are interested in using because it allows for both over- and under-dispersion relative to the Poisson distribution.
Another distribution with these properties is the generalized Poisson distribution described by <a href="https://doi.org/10.1080/00401706.1973.10489112">Consul and Jain (1973)</a>.</p>
<p>In this post, I’ll walk through my implementation of the GPO in Stan.
The <a href="https://cran.r-project.org/package=gamlss.dist"><code>gamlss.dist</code> package</a> provides a full set of distributional functions for the generalized Poisson distribution, including a sampler, but the functions are configured to only allow for over-dispersion. Since I’m interested in allowing for under-dispersion as well, I’ll need to write my own functions. As in my previous post, I can validate my Stan functions against the functions from <code>gamlss.dist</code> (although only for over-dispersion scenarios).</p>
<pre class="r"><code>library(tidyverse)
library(patchwork)   # composing figures
library(gamlss.dist) # DPO distribution functions
library(rstan)       # Stan interface to R
library(brms)        # fitting generalized linear models
library(bayesplot)   # Examine fitted models
library(loo)         # Model fit measures</code></pre>
<div id="the-generalized-poisson" class="section level2">
<h2>The generalized Poisson</h2>
<p>Consul and Jain’s generalized Poisson distribution is a discrete distribution for non-negative counts, with support <span class="math inline">\(\mathcal{S}_X = \{0, 1, 2, 3, ...\}\)</span>.
The mean-variance relationship of the generalized Poisson is constant; for <span class="math inline">\(X \sim GPO(\mu, \phi)\)</span>, <span class="math inline">\(\text{E}(X) = \mu\)</span> and <span class="math inline">\(\text{Var}(X) = \mu / \phi\)</span> for <span class="math inline">\(0 &lt; \phi &lt; 1\)</span>; the expectation and variance are not exact but are close approximations when there is underdispersion, so <span class="math inline">\(\phi &gt; 1\)</span>. Thus, like the double-Poisson distribution, the generalized Poisson satisfies the assumptions of a quasi-Poisson generalized linear model (at least approximately).</p>
<p>The density of the generalized Poisson distribution with mean <span class="math inline">\(\mu\)</span> and inverse-disperson <span class="math inline">\(\phi\)</span> is:
<span class="math display">\[
f(x | \mu, \phi) = \mu \sqrt{\phi} \left( x + \sqrt{\phi}(\mu - x) \right)^{x-1} \frac{\exp \left[-\left( x + \sqrt{\phi}(\mu - x)\right)\right]}{x!}.
\]</span>
We then have
<span class="math display">\[
\ln f(x | \mu, \phi) = \frac{1}{2} \ln \phi + \ln \mu + (x - 1) \ln \left( x + \sqrt{\phi}(\mu - x) \right) - \left( x + \sqrt{\phi}(\mu - x) \right) - \ln \left(x!\right).
\]</span>
Using the GPO with under-dispersed data is a little bit more controversial (by statistical standards) than using the DPO.
This is because, for parameter values corresponding to under-dispersion, its probability mass function becomes negative for large counts. In particular, note that for values <span class="math inline">\(x &gt; \frac{\mu\sqrt\phi}{\sqrt\phi - 1}\)</span>, the quantity <span class="math inline">\(x + \sqrt{\phi}(\mu - x)\)</span> becomes negative, and so <span class="math inline">\(f(x| \mu, \phi)\)</span> is no longer a proper probability.
Consul suggested handling this situation by truncating the distribution at <span class="math inline">\(m = \left\lfloor \frac{\mu\sqrt\phi}{\sqrt\phi - 1}\right\rfloor\)</span>. However, doing so makes the distribution only an approximation, such that <span class="math inline">\(\mu\)</span> is no longer exactly the mean and <span class="math inline">\(\phi\)</span> is no longer exactly the inverse dispersion.
For modest under-dispersion of no less than 60% of the mean, <span class="math inline">\(1 &lt; \phi &lt; 5 / 3\)</span> and the truncation point is fairly extreme, with <span class="math inline">\(m \approx 4.4 \mu\)</span>, so I’m not too worried about this issue.
We’ll see how it plays out in application, of course.</p>
</div>
<div id="log-of-the-probability-mass-function" class="section level1">
<h1>Log of the probability mass function</h1>
<p>Here’s a Stan function implementing the lpmf, with the truncation bit:</p>
<pre class="r"><code>stancode_lpmf &lt;- &quot;
real gpo_lpmf(int X, real mu, real phi) {
  real ans;
  real m = mu / (1 - inv(sqrt(phi)));
  real z = X + sqrt(phi) * (mu - X);
  if (phi &gt; 1 &amp;&amp; X &gt; m)
    ans = negative_infinity();
  else 
    ans = log(mu) + inv(2) * log(phi) + (X - 1) * log(z) - z - lgamma(X + 1);
  return ans;
}
&quot;</code></pre>
<p>To check that this is accurate, I’ll compare the Stan function to the corresponding function from <code>gamlss.dist</code> for a couple of different parameter values and for <span class="math inline">\(x = 0,...,100\)</span>. If my function is accurate, my calculated log-probabilities should be equal to the results from <code>gamlss.dist::dGPO</code>. Note that the <code>gamlss.dist</code> function uses a different parameterization for the dispersion, with <span class="math inline">\(\sigma = \frac{\phi^{-1/2} - 1}{\mu}\)</span>.</p>
<pre class="r"><code>writeLines(paste(&quot;functions {&quot;, stancode_lpmf, &quot;}&quot;, sep = &quot;\n&quot;), &quot;GPO-lpmf.stan&quot;)
expose_stan_functions(&quot;GPO-lpmf.stan&quot;)

test_lpmf &lt;- 
  expand_grid(
    mu = c(2, 5, 10, 20),
    phi = seq(0.1, 0.9, 0.1),
    X = 0:100
  ) %&gt;%
  mutate(
    sigma = (phi^(-1/2) - 1) / mu,
    gamlss_lpmf = dGPO(x = X, mu = mu, sigma = sigma, log = TRUE),
    my_lpmf = pmap_dbl(.l = list(X = X, mu = mu, phi = phi), .f = gpo_lpmf),
    diff = my_lpmf - gamlss_lpmf
  )</code></pre>
<pre class="r"><code>ggplot(test_lpmf, aes(factor(phi), diff, color = factor(phi))) + 
  geom_boxplot() + 
  facet_wrap( ~ mu, labeller = &quot;label_both&quot;, ncol = 2) + 
  theme_minimal() + 
  labs(x = &quot;phi&quot;) + 
  theme(legend.position = &quot;none&quot;)</code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>Checks out. Onward!</p>
</div>
<div id="quantile-function" class="section level1">
<h1>Quantile function</h1>
<p>I’ll next implement the generalized Poisson quantile function, taking advantage of a recurrence relationship for sequential values. Note that
<span class="math display">\[
\begin{aligned}
f(0 | \mu, \phi) &amp;= \exp \left(-\mu \sqrt{\phi}\right) \\
f(x | \mu, \phi) &amp;= f(x - 1 | \mu, \phi) \times \frac{\left(x + \sqrt{\phi}(\mu - x)\right)^{x - 1}}{\left(x - 1 + \sqrt{\phi}(\mu - (x - 1))\right)^{x - 2}} \times \frac{\exp(\sqrt{\phi} - 1)}{x}
\end{aligned}
\]</span>
where the second expression holds for <span class="math inline">\(x \geq 1\)</span>.</p>
<p>The function below computes the quantile given a value <span class="math inline">\(p\)</span> by computing the cumulative distribution function until <span class="math inline">\(p\)</span> is exceeded:</p>
<pre class="r"><code>stancode_quantile &lt;- &quot; 
int gpo_quantile(real p, real mu, real phi) {
  int q = 0;
  real phi_sqrt = sqrt(phi);
  real mu_phi_sqrt = mu * phi_sqrt;
  real m;
  if (phi &gt; 1) 
    m = mu / (1 - inv(phi_sqrt));
  else 
    m = positive_infinity();
  real lpmf = - mu_phi_sqrt;
  real cdf = exp(lpmf);
  real ln_inc;
  while (cdf &lt; p &amp;&amp; q &lt; m) {
    q += 1;
    ln_inc = (q - 1) * log(mu_phi_sqrt + q * (1 - phi_sqrt)) - (q - 2) * log(mu_phi_sqrt + (q - 1) * (1 - phi_sqrt)) + (phi_sqrt - 1) - log(q);
    lpmf += ln_inc;    
    cdf += exp(lpmf);
  }
  return q;
}
&quot;</code></pre>
<p>If my quantile function is accurate, it should match the value computed from <code>gamlss.dist::qDPO()</code> exactly.</p>
<pre class="r"><code>writeLines(paste(&quot;functions {&quot;, stancode_quantile, &quot;}&quot;, sep = &quot;\n&quot;), &quot;GPO-quantile.stan&quot;)
expose_stan_functions(&quot;GPO-quantile.stan&quot;)

test_quantile &lt;- 
  expand_grid(
    mu = c(2, 5, 10, 20),
    phi = seq(0.1, 0.9, 0.1),
  ) %&gt;%
  mutate(
    sigma = (phi^(-1/2) - 1) / mu,
    p = map(1:n(), ~ runif(100)),
  ) %&gt;%
  unnest(p) %&gt;%
  mutate(
    my_q = pmap_dbl(list(p = p, mu = mu, phi = phi), .f = gpo_quantile),
    gamlss_q = qGPO(p, mu = mu, sigma = sigma),
    diff = my_q - gamlss_q
  )</code></pre>
<pre class="r"><code>ggplot(test_quantile, aes(factor(phi), diff, color = factor(phi))) + 
  geom_boxplot() + 
  facet_wrap( ~ mu, labeller = &quot;label_both&quot;, ncol = 2) + 
  theme_minimal() + 
  labs(x = &quot;phi&quot;) + 
  theme(legend.position = &quot;none&quot;)</code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/check-quantile-plot-1.png" width="672" /></p>
<p>I should enter this figure in the competition for the world’s most boring statistical graphic.</p>
</div>
<div id="sampler" class="section level1">
<h1>Sampler</h1>
<p>The last thing I’ll need is a sampler, which I’ll implement by generating random points from a uniform distribution, then computing the generalized Poisson quantiles of these random points. My implementation just generates a single random variate:</p>
<pre class="r"><code>stancode_qr &lt;- &quot;
int gpo_quantile(real p, real mu, real phi) {
  int q = 0;
  real phi_sqrt = sqrt(phi);
  real mu_phi_sqrt = mu * phi_sqrt;
  real m;
  if (phi &gt; 1) 
    m = mu / (1 - inv(phi_sqrt));
  else 
    m = positive_infinity();
  real lpmf = - mu_phi_sqrt;
  real cdf = exp(lpmf);
  real ln_inc;
  while (cdf &lt; p &amp;&amp; q &lt; m) {
    q += 1;
    ln_inc = (q - 1) * log(mu_phi_sqrt + q * (1 - phi_sqrt)) - (q - 2) * log(mu_phi_sqrt + (q - 1) * (1 - phi_sqrt)) + (phi_sqrt - 1) - log(q);
    lpmf += ln_inc;    
    cdf += exp(lpmf);
  }
  return q;
}

int gpo_rng(real mu, real phi) {
  real p = uniform_rng(0,1);
  int x = gpo_quantile(p, mu, phi);
  return x;
}
&quot;</code></pre>
<p>To check this function, I’ll generate some large samples from the generalized Poisson with a few different parameter sets. If the sampler is working properly, the empirical cumulative distribution should line up closely with the cumulative distribution computed using <code>gamlss.dist::pGPO()</code>.</p>
<pre class="r"><code>writeLines(paste(&quot;functions {&quot;, stancode_qr, &quot;}&quot;, sep = &quot;\n&quot;), &quot;GPO-rng.stan&quot;)
expose_stan_functions(&quot;GPO-rng.stan&quot;)

gpo_rng_sampler &lt;- function(N, mu, phi) {
  replicate(N, gpo_rng(mu = mu, phi = phi))
}

test_rng &lt;- 
  expand_grid(
    mu = c(2, 5, 10, 20),
    phi = seq(0.1, 0.9, 0.1),
  ) %&gt;%
  mutate(
    sigma = (phi^(-1/2) - 1) / mu,
    x = pmap(.l = list(N = 10000, mu = mu, phi = phi), .f = gpo_rng_sampler),
    tb = map(x, ~ as.data.frame(table(.x)))
  ) %&gt;%
  dplyr::select(-x) %&gt;%
  group_by(mu, phi) %&gt;%
  unnest(tb) %&gt;%
  mutate(
    .x = as.integer(levels(.x))[.x],
    Freq_cum = cumsum(Freq) / 10000,
    gamlss_F = pGPO(q = .x, mu = mu, sigma = sigma)
  )</code></pre>
<pre class="r"><code>ggplot(test_rng, aes(gamlss_F, Freq_cum, color = factor(phi))) + 
  geom_abline(slope = 1, color = &quot;blue&quot;, linetype = &quot;dashed&quot;) + 
  geom_point() + geom_line() +  
  facet_grid(phi ~ mu, labeller = &quot;label_both&quot;) + 
  theme_minimal() + 
  labs(x = &quot;Theoretical cdf (gamlss.dist)&quot;, y = &quot;Empirical cdf (my function)&quot;) + 
  theme(legend.position = &quot;none&quot;) </code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/check-rng-plot-1.png" width="672" />
Another approach to checking the sampler is to simulate a bunch of observations and check whether the empirical mean and variance match the theoretical moments. I’ll do this as well, using some values of <span class="math inline">\(\phi &gt; 1\)</span> to test whether the sampler still works when there’s under-dispersion.</p>
<pre class="r"><code>test_moments &lt;- 
  expand_grid(
    mu = c(5, 10, 20, 40, 60),
    phi = seq(1, 2, 0.1),
  ) %&gt;%
  mutate(
    x = pmap(.l = list(N = 1e5, mu = mu, phi = phi), .f = gpo_rng_sampler),
    M = map_dbl(x, mean),
    S = map_dbl(x, sd),
    M_ratio = M / mu,
    S_ratio = S / sqrt(mu / phi)
  ) %&gt;%
  dplyr::select(-x) %&gt;%
  pivot_longer(ends_with(&quot;_ratio&quot;),names_to = &quot;moment&quot;,values_to = &quot;ratio&quot;) %&gt;%
  mutate(
    moment = factor(moment, levels = c(&quot;M_ratio&quot;, &quot;S_ratio&quot;), labels = c(&quot;Sample mean&quot;, &quot;Standard deviation&quot;)),
    mu = factor(mu)
  )

ggplot(test_moments, aes(phi, ratio, color = mu)) + 
  geom_point() + geom_line() + 
  facet_wrap(~ moment) + 
  theme_minimal()</code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/test-sample-moments-1.png" width="768" />
Looks like the sample moments closely match the parameter values, with deviations that look pretty much like random error. Nice!</p>
</div>
<div id="using-the-custom-distribution-functions" class="section level1">
<h1>Using the custom distribution functions</h1>
<p>To finish out my tests of these functions, I’ll try out a small simulation. Following my <a href="/Double-Poisson-in-Stan/">previous post</a>, I’ll generate data based on a generalized linear model with a single predictor <span class="math inline">\(X\)</span>, where the outcome <span class="math inline">\(Y\)</span> follows a generalized Poisson distribution conditional on <span class="math inline">\(X\)</span>. The data-generating process is:</p>
<p><span class="math display">\[
\begin{aligned}
X &amp;\sim \Gamma(6,2) \\
Y|X &amp;\sim GPO(\mu(X), \phi) \\
\log \mu(X) &amp;= 2 + 0.3 \times X
\end{aligned}
\]</span>
with the dispersion parameter set to <span class="math inline">\(\phi = 6/10\)</span> so that the outcome is <em>over</em>-dispersed. I’m looking at over-dispersion here so that the negative binomial has a chance to keep up, since it doesn’t allow for any degree of under-dispersion.</p>
<p>The following code generates a large sample from the data-generating process:</p>
<pre class="r"><code>set.seed(20231206)
N &lt;- 1500
X &lt;- rgamma(N, shape = 6, rate = 2)
mu &lt;- exp(2 + 0.3 * X)
phi &lt;- 6 / 10
Y &lt;- map_dbl(mu, gpo_rng, phi = phi)
dat &lt;- data.frame(X = X, Y = Y)</code></pre>
<p>Here’s what the sample looks like, along with a smoothed regression estimated using a basic cubic spline:</p>
<pre class="r"><code>ggplot(dat, aes(X, Y)) + 
  geom_point(alpha = 0.1) + 
  geom_smooth(method = &#39;gam&#39;, formula = y ~ s(x, bs = &quot;cs&quot;)) + 
  theme_minimal()</code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/glm-scatterplot-1.png" width="576" />
Here is a fit using quasi-likelihood estimation of a log-linear model:</p>
<pre class="r"><code>quasi_fit &lt;- glm(Y ~ X, family = quasipoisson(link = &quot;log&quot;), data = dat)
summary(quasi_fit)</code></pre>
<pre><code>## 
## Call:
## glm(formula = Y ~ X, family = quasipoisson(link = &quot;log&quot;), data = dat)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -5.3261  -0.9290  -0.0912   0.7371   5.0944  
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 1.981959   0.020609   96.17   &lt;2e-16 ***
## X           0.306733   0.005525   55.52   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for quasipoisson family taken to be 1.680427)
## 
##     Null deviance: 7248.1  on 1499  degrees of freedom
## Residual deviance: 2520.5  on 1498  degrees of freedom
## AIC: NA
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<p>This approach recovers the data-generating parameters quite well, with a dispersion estimate of 1.68 compared to the true dispersion parameter of 1.67.</p>
<div id="candidate-models" class="section level2">
<h2>Candidate models</h2>
<p>Now let me fit the same generalized linear model but assuming that the outcome follow a couple of different distributions, including a true Poisson (with unit dispersion), a negative binomial, the double-Poisson distribution from the previous post, and the generalized Poisson distribution. Here goes!</p>
<pre class="r"><code>Poisson_fit &lt;- 
  brm(
    Y ~ X, family = poisson(link = &quot;log&quot;),
    data = dat, 
    warmup = 500, 
    iter = 2500, 
    chains = 4, 
    cores = 4,
    seed = 20231204
  )</code></pre>
<pre class="r"><code>negbin_fit &lt;- 
  brm(
    Y ~ X, family = negbinomial(link = &quot;log&quot;),
    data = dat, 
    warmup = 500, 
    iter = 2500, 
    chains = 4, 
    cores = 4,
    seed = 20231204
  )</code></pre>
<pre class="r"><code>stancode_dpo &lt;- &quot;
real dpo_lpmf(int X, real mu, real phi) {
  real ans;
  real A = inv(2) * log(phi) - phi * mu;
  if (X == 0)
    ans = A;
  else
    ans = A + X * (phi * (1 + log(mu)) - 1) - lgamma(X + 1) + (1 - phi) * X * log(X);
  return ans;
}
vector dpo_cdf(real mu, real phi, int maxval) {
  real d = exp(phi * (1 + log(mu)) - 1);
  real prob;
  int n = maxval + 1;
  vector[n] cdf;
  cdf[1] = sqrt(phi) * exp(-mu * phi);
  prob = cdf[1] * d;
  cdf[2] = cdf[1] + prob;
  for (i in 2:maxval) {
    prob = prob * d * exp((1 - phi) * (i - 1) * (log(i) - log(i - 1))) / (i^phi);
    cdf[i + 1] = cdf[i] + prob;
    if (prob / cdf[i + 1] &lt; 1e-8) {
      n = i + 1;
      break;
    }
  }
  return cdf / cdf[n];
}
int dpo_quantile(real p, real mu, real phi, int maxval) {
  vector[maxval + 1] cdf_vec = dpo_cdf(mu, phi, maxval);
  int q = 0;
  while (cdf_vec[q + 1] &lt; p) {
      q += 1;
    }
  return q;
}
int dpo_rng(real mu, real phi, int maxval) {
  real p = uniform_rng(0,1);
  int x = dpo_quantile(p, mu, phi, maxval);
  return x;
}
&quot;
double_Poisson &lt;- custom_family(
  &quot;dpo&quot;, dpars = c(&quot;mu&quot;,&quot;phi&quot;),
  links = c(&quot;log&quot;,&quot;log&quot;),
  lb = c(0, 0), ub = c(NA, NA),
  type = &quot;int&quot;
)

double_Poisson_stanvars &lt;- stanvar(scode = stancode_dpo, block = &quot;functions&quot;)

phi_prior &lt;- prior(exponential(1), class = &quot;phi&quot;)

DPO_fit &lt;- 
  brm(
    Y ~ X, family = double_Poisson,
    prior = phi_prior,
    stanvars = double_Poisson_stanvars,
    data = dat, 
    warmup = 500, 
    iter = 2500, 
    chains = 4, 
    cores = 4,
    seed = 20231204
  )

expose_functions(DPO_fit, vectorize = TRUE)

log_lik_dpo &lt;- function(i, prep) {
  mu &lt;- brms::get_dpar(prep, &quot;mu&quot;, i = i)
  phi &lt;- brms::get_dpar(prep, &quot;phi&quot;, i = i)
  y &lt;- prep$data$Y[i]
  dpo_lpmf(y, mu, phi)
}

posterior_predict_dpo &lt;- function(i, prep, maxval = NULL, ...) {
  mu &lt;- brms::get_dpar(prep, &quot;mu&quot;, i = i)
  phi &lt;- brms::get_dpar(prep, &quot;phi&quot;, i = i)
  if (is.null(maxval)) maxval &lt;- 20 * mu / min(phi, 1)
  dpo_rng(mu, phi, maxval = maxval)
}</code></pre>
<pre class="r"><code>stancode_gpo &lt;- &quot;
real gpo_lpmf(int X, real mu, real phi) {
  real ans;
  real m = mu / (1 - inv(sqrt(phi)));
  real z = X + sqrt(phi) * (mu - X);
  if (phi &gt; 1 &amp;&amp; X &gt; m)
    ans = negative_infinity();
  else 
    ans = log(mu) + inv(2) * log(phi) + (X - 1) * log(z) - z - lgamma(X + 1);
  return ans;
}
int gpo_quantile(real p, real mu, real phi) {
  int q = 0;
  real phi_sqrt = sqrt(phi);
  real mu_phi_sqrt = mu * phi_sqrt;
  real m;
  if (phi &gt; 1) 
    m = mu / (1 - inv(phi_sqrt));
  else 
    m = positive_infinity();
  real lpmf = - mu_phi_sqrt;
  real cdf = exp(lpmf);
  real ln_inc;
  while (cdf &lt; p &amp;&amp; q &lt; m) {
    q += 1;
    ln_inc = (q - 1) * log(mu_phi_sqrt + q * (1 - phi_sqrt)) - (q - 2) * log(mu_phi_sqrt + (q - 1) * (1 - phi_sqrt)) + (phi_sqrt - 1) - log(q);
    lpmf += ln_inc;    
    cdf += exp(lpmf);
  }
  return q;
}
int gpo_rng(real mu, real phi) {
  real p = uniform_rng(0,1);
  int x = gpo_quantile(p, mu, phi);
  return x;
}
&quot;
generalized_Poisson &lt;- custom_family(
  &quot;gpo&quot;, dpars = c(&quot;mu&quot;,&quot;phi&quot;),
  links = c(&quot;log&quot;,&quot;log&quot;),
  lb = c(0, 0), ub = c(NA, NA),
  type = &quot;int&quot;
)

generalized_Poisson_stanvars &lt;- stanvar(scode = stancode_gpo, block = &quot;functions&quot;)

phi_prior &lt;- prior(exponential(1), class = &quot;phi&quot;)

GPO_fit &lt;- 
  brm(
    Y ~ X, family = generalized_Poisson,
    prior = phi_prior,
    stanvars = generalized_Poisson_stanvars,
    data = dat, 
    warmup = 500, 
    iter = 2500, 
    chains = 4, 
    cores = 4,
    seed = 20231204
  )

expose_functions(GPO_fit, vectorize = TRUE)

log_lik_gpo &lt;- function(i, prep) {
  mu &lt;- brms::get_dpar(prep, &quot;mu&quot;, i = i)
  phi &lt;- brms::get_dpar(prep, &quot;phi&quot;, i = i)
  y &lt;- prep$data$Y[i]
  gpo_lpmf(y, mu, phi)
}

posterior_predict_gpo &lt;- function(i, prep, maxval = NULL, ...) {
  mu &lt;- brms::get_dpar(prep, &quot;mu&quot;, i = i)
  phi &lt;- brms::get_dpar(prep, &quot;phi&quot;, i = i)
  gpo_rng(mu, phi)
}</code></pre>
</div>
<div id="model-comparison" class="section level2">
<h2>Model comparison</h2>
<p>Here is a comparison of LOOIC for all of the models:</p>
<pre class="r"><code>loo_comparison &lt;- loo(Poisson_fit, negbin_fit, DPO_fit, GPO_fit)
loo_comparison$diffs</code></pre>
<pre><code>##             elpd_diff se_diff
## DPO_fit        0.0       0.0 
## GPO_fit       -2.9       2.8 
## negbin_fit    -8.9       4.4 
## Poisson_fit -120.7      20.1</code></pre>
<p>The model based on the double-Poisson distribution fits equally well to the true data-generating process here, suggesting that there’s really just not enough information to distriguish between the two models. The negative binomial distribution fit is substantially worse, and the Poisson distribution fit is awful.</p>
<p>Here’s the posterior for the dispersion (i.e., <span class="math inline">\(1 / \phi\)</span>) based on the GPO and DPO models:</p>
<pre class="r"><code>color_scheme_set(&quot;green&quot;)
GPO_dispersion &lt;- 
  mcmc_areas(GPO_fit, pars = &quot;phi&quot;, transformations = \(x) 1 / x) + 
  theme_minimal() + 
  ggtitle(&quot;Generalized Poisson&quot;)

color_scheme_set(&quot;brightblue&quot;)
DPO_dispersion &lt;- 
  mcmc_areas(DPO_fit, pars = &quot;phi&quot;, transformations = \(x) 1 / x) + 
  theme_minimal() + 
  ggtitle(&quot;Double Poisson&quot;)

DPO_dispersion / GPO_dispersion &amp; 
  xlim(1.5, 2.0)</code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/dispersion-comparison-1.png" width="480" /></p>
<p>Right on par. To get a better sense of model fit, I’ll run some posterior predictive checks, using the quasi-likelihood dispersion as a summary statistic:</p>
<pre class="r"><code>Yrep_Poisson &lt;- posterior_predict(Poisson_fit, ndraws = 500) 
Yrep_negbin &lt;- posterior_predict(negbin_fit, ndraws = 500)
Yrep_dpo &lt;- posterior_predict(DPO_fit, ndraws = 500)
Yrep_gpo &lt;- posterior_predict(GPO_fit, ndraws = 500)

dispersion_coef &lt;- function(y) {
  quasi_fit &lt;- glm(y ~ dat$X, family = quasipoisson(link = &quot;log&quot;))
  sum(residuals(quasi_fit, type = &quot;pearson&quot;)^2) / quasi_fit$df.residual
}

color_scheme_set(&quot;blue&quot;)
Poisson_disp &lt;- ppc_stat(dat$Y, Yrep_Poisson, stat = dispersion_coef, binwidth = 0.02) + 
  labs(title = &quot;Poisson&quot;)

color_scheme_set(&quot;purple&quot;)
negbin_disp &lt;- ppc_stat(dat$Y, Yrep_negbin, stat = dispersion_coef, binwidth = 0.02) + 
  labs(title = &quot;Negative-binomial&quot;)

color_scheme_set(&quot;brightblue&quot;)
dpo_disp &lt;- ppc_stat(dat$Y, Yrep_dpo, stat = dispersion_coef, binwidth = 0.02) + 
  labs(title = &quot;Double Poisson&quot;)

color_scheme_set(&quot;green&quot;)
gpo_disp &lt;- ppc_stat(dat$Y, Yrep_gpo, stat = dispersion_coef, binwidth = 0.02) + 
  labs(title = &quot;Generalized Poisson&quot;)

Poisson_disp / negbin_disp / dpo_disp / gpo_disp &amp;
  theme_minimal() &amp; 
  xlim(c(0.8, 2.1))</code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/ppc-dispersion-1.png" width="768" /></p>
<p>Both the double Poisson and the generalized Poisson models generate data with levels of dispersion similar to the observed data. The negative binomial distribution is not noticeably worse.</p>
</div>
<div id="marginal-posterior-predictive-densities" class="section level2">
<h2>Marginal posterior predictive densities</h2>
<p>Here’s some rootograms for the posterior predictive density of the raw outcomes:</p>
<pre class="r"><code>color_scheme_set(&quot;blue&quot;)
Poisson_root &lt;- ppc_rootogram(dat$Y, Yrep_Poisson, style = &quot;hanging&quot;) + labs(title = &quot;Poisson&quot;)
color_scheme_set(&quot;purple&quot;)
negbin_root &lt;- ppc_rootogram(dat$Y, Yrep_negbin, style = &quot;hanging&quot;) + labs(title = &quot;Negative-binomial&quot;)
color_scheme_set(&quot;brightblue&quot;)
dpo_root &lt;- ppc_rootogram(dat$Y, Yrep_dpo, style = &quot;hanging&quot;) + labs(title = &quot;Double Poisson&quot;)
color_scheme_set(&quot;green&quot;)
gpo_root &lt;- ppc_rootogram(dat$Y, Yrep_gpo, style = &quot;hanging&quot;) + labs(title = &quot;Generalized Poisson&quot;)

Poisson_root / negbin_root / dpo_root / gpo_root &amp;
  theme_minimal()</code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/ppd-1.png" width="672" />
You can see from these that the Poisson model maybe expects slightly fewer low counts and slightly fewer high counts than are present in the observed data. However, the figure doesn’t really capture the degree of mis-fit that is apparent with the dispersion summary statistics. I think this is because the distribution of <span class="math inline">\(Y\)</span> changes so much depending on the value of the predictor <span class="math inline">\(X\)</span>.</p>
</div>
<div id="posterior-predictive-residual-densities" class="section level2">
<h2>Posterior predictive residual densities</h2>
<p>One way to focus in on the distributional assumption is to examine the distribution of residuals rather than raw outcomes. I’ll do that here by looking the deviance residuals from the quasi-Poisson GLM model, treating the calculation of the residuals as merely a transformation of the raw data. Here are some posterior predictive density plots of these deviance residuals:</p>
<pre class="r"><code># quasi-Poisson deviance residuals
dat$resid &lt;- residuals(quasi_fit)

# function to calculate quasi-Poisson deviance residuals
quasi_residuals &lt;- function(y) as.numeric(residuals(glm(y ~ dat$X, family = quasipoisson(link = &quot;log&quot;))))

# transform posterior predictive data into residuals
R &lt;- 50
resid_Poisson &lt;- apply(Yrep_Poisson[1:R,], 1, quasi_residuals) |&gt; t()
resid_negbin &lt;- apply(Yrep_negbin[1:R,], 1, quasi_residuals) |&gt; t()
resid_dpo &lt;- apply(Yrep_dpo[1:R,], 1, quasi_residuals) |&gt; t()
resid_gpo &lt;- apply(Yrep_gpo[1:R,], 1, quasi_residuals) |&gt; t()

# make density plots
color_scheme_set(&quot;blue&quot;)
Poisson_resid_density &lt;- ppc_dens_overlay(dat$resid, resid_Poisson) + labs(title = &quot;Poisson&quot;)

color_scheme_set(&quot;purple&quot;)
negbin_resid_density &lt;- ppc_dens_overlay(dat$resid, resid_negbin) + labs(title = &quot;Negative-binomial&quot;)

color_scheme_set(&quot;brightblue&quot;)
dpo_resid_density &lt;- ppc_dens_overlay(dat$resid, resid_dpo) + labs(title = &quot;Double Poisson&quot;)

color_scheme_set(&quot;green&quot;)
gpo_resid_density &lt;- ppc_dens_overlay(dat$resid, resid_gpo) + labs(title = &quot;Generalized Poisson&quot;)

Poisson_resid_density / negbin_resid_density / dpo_resid_density / gpo_resid_density &amp;
  theme_minimal() &amp; 
  xlim(c(-3.5, 3.5))</code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/ppd-residuals-1.png" width="576" /></p>
<p>It’s quite a bit clearer from these plots that the DPO and GPO models are closer to replicating the distribution of the data than the Poisson model.
The negative binomial model is not obviously mis-specified either.</p>
<p>A notable difference between the negative binomial versus the DPO and GPO distributions is in the form of the mean-variance relationship.
For the negative binomial, the variance increases with the square of the mean, whereas for the DPO and GPO, the variance increases in constant proportion to the mean.
The residual posterior density plots above don’t really capture these mean-variance relationships in an obvious way.
I took one more crack at a posterior predictive check to get at this.
Below is a figure showing the loess smooth of the squared residuals versus <span class="math inline">\(X\)</span> based on the posterior predictive distributions versus the real data. I couldn’t find an easy way to do this with the <code>bayesplot</code> functions I’ve used above, so I had to bang it out in regular <code>ggplot</code>.</p>
<pre class="r"><code>X_grid &lt;- seq(min(dat$X), max(dat$X), length.out = 200)

smooth_square_resid &lt;- function(r, x_dat, X_pred = X_grid) {
  loess_fit &lt;- loess(I(r^2) ~ x_dat)
  predict(loess_fit, newdata = data.frame(x_dat = X_pred))
}

dat$sm &lt;- smooth_square_resid(r = dat$resid, x_dat = dat$X, X_pred = dat$X)

smooth_square_resid_ppcs &lt;- function(R, x_dat, X_pred = X_grid) {
  smooth_list &lt;- apply(R, 1, smooth_square_resid, x_dat = dat$X, X_pred = X_pred, simplify = FALSE)
  tibble(
    group = 1:length(smooth_list),
    X = rep(list(X_pred), length(smooth_list)),
    sm = smooth_list
  )
}

smooth_MV &lt;- 
  list(
    Poisson = resid_Poisson, 
    `Negative binomial` = resid_negbin,
    `Double Poisson` = resid_dpo,
    `Generalized Poisson` = resid_gpo
  ) %&gt;%
  map_dfr(smooth_square_resid_ppcs, x_dat = dat$X, .id = &quot;distribution&quot;) %&gt;%
  unnest(X, sm) %&gt;%
  mutate(
    distribution = factor(distribution, levels = c(&quot;Poisson&quot;, &quot;Negative binomial&quot;,&quot;Double Poisson&quot;, &quot;Generalized Poisson&quot;))
  )

ggplot(smooth_MV, aes(X, sm, group = group, color = distribution)) + 
  geom_line(alpha = 0.4) + 
  geom_line(data = dat, aes(X, sm, group = NULL), color = &quot;black&quot;, linewidth = 1.25) + 
  scale_color_manual(values = c(&quot;grey&quot;,&quot;purple&quot;,&quot;lightblue&quot;,&quot;lightgreen&quot;)) + 
  scale_y_continuous(limits = c(0, 9), breaks = seq(0,8,2), expand = expansion(0,0)) + 
  facet_wrap(~ distribution, ncol = 1) + 
  theme_minimal() + 
  theme(legend.position = &quot;none&quot;) + 
  labs(y = &quot;Loess smooth of squared residuals&quot;)</code></pre>
<p><img src="/post/Generalized-Poisson-in-Stan_files/figure-html/ppd-residual-smooth-1.png" width="576" />
Aha! Here we can clearly see that the negative binomial model generates residuals that have more curvature to the mean-variance relationship, and so don’t really fit with the observed data. The double Poisson and generalized Poisson both generate residuals that match the observed mean-variance relationship decently well.</p>
</div>
</div>
<div id="colophon" class="section level1">
<h1>Colophon</h1>
<pre><code>## R version 4.2.2 (2022-10-31 ucrt)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 10 x64 (build 19045)
## 
## Matrix products: default
## 
## locale:
## [1] LC_COLLATE=English_United States.utf8 
## [2] LC_CTYPE=English_United States.utf8   
## [3] LC_MONETARY=English_United States.utf8
## [4] LC_NUMERIC=C                          
## [5] LC_TIME=English_United States.utf8    
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] loo_2.5.1           bayesplot_1.9.0     brms_2.18.0        
##  [4] Rcpp_1.0.10         rstan_2.26.23       StanHeaders_2.26.27
##  [7] gamlss.dist_6.0-3   MASS_7.3-57         patchwork_1.1.3    
## [10] lubridate_1.9.2     forcats_1.0.0       stringr_1.5.0      
## [13] dplyr_1.1.2         purrr_1.0.2         readr_2.1.4        
## [16] tidyr_1.3.0         tibble_3.2.1        ggplot2_3.4.3      
## [19] tidyverse_2.0.0    
## 
## loaded via a namespace (and not attached):
##   [1] TH.data_1.1-2        colorspace_2.1-0     RcppEigen_0.3.3.9.2 
##   [4] ellipsis_0.3.2       ggridges_0.5.3       estimability_1.3    
##   [7] markdown_1.7         QuickJSR_1.0.5       base64enc_0.1-3     
##  [10] rstudioapi_0.15.0    farver_2.1.1         DT_0.29             
##  [13] fansi_1.0.4          mvtnorm_1.1-3        splines_4.2.2       
##  [16] bridgesampling_1.1-2 codetools_0.2-18     cachem_1.0.6        
##  [19] knitr_1.40           shinythemes_1.2.0    jsonlite_1.8.4      
##  [22] shiny_1.7.4          compiler_4.2.2       emmeans_1.7.3       
##  [25] backports_1.4.1      Matrix_1.6-3         fastmap_1.1.0       
##  [28] cli_3.6.1            later_1.3.0          htmltools_0.5.4     
##  [31] prettyunits_1.1.1    tools_4.2.2          igraph_1.3.5        
##  [34] coda_0.19-4          gtable_0.3.4         glue_1.6.2          
##  [37] reshape2_1.4.4       posterior_1.3.1      jquerylib_0.1.4     
##  [40] vctrs_0.6.3          nlme_3.1-157         blogdown_1.10       
##  [43] crosstalk_1.2.0      tensorA_0.36.2       xfun_0.40           
##  [46] ps_1.6.0             timechange_0.2.0     mime_0.12           
##  [49] miniUI_0.1.1.1       lifecycle_1.0.3      gtools_3.9.3        
##  [52] zoo_1.8-10           scales_1.2.1         colourpicker_1.1.1  
##  [55] hms_1.1.3            promises_1.2.0.1     Brobdingnag_1.2-9   
##  [58] parallel_4.2.2       sandwich_3.0-1       inline_0.3.19       
##  [61] shinystan_2.6.0      yaml_2.3.5           gridExtra_2.3       
##  [64] sass_0.4.5           stringi_1.7.12       highr_0.9           
##  [67] dygraphs_1.1.1.6     checkmate_2.1.0      pkgbuild_1.3.1      
##  [70] rlang_1.1.1          pkgconfig_2.0.3      matrixStats_0.62.0  
##  [73] BH_1.78.0-0          distributional_0.3.1 evaluate_0.18       
##  [76] lattice_0.20-45      labeling_0.4.3       rstantools_2.2.0    
##  [79] htmlwidgets_1.6.2    processx_3.7.0       tidyselect_1.2.0    
##  [82] plyr_1.8.8           magrittr_2.0.3       bookdown_0.26       
##  [85] R6_2.5.1             generics_0.1.3       multcomp_1.4-23     
##  [88] mgcv_1.8-41          pillar_1.9.0         withr_2.5.0         
##  [91] xts_0.12.1           survival_3.4-0       abind_1.4-5         
##  [94] crayon_1.5.2         utf8_1.2.3           tzdb_0.3.0          
##  [97] rmarkdown_2.18       grid_4.2.2           callr_3.7.2         
## [100] threejs_0.3.3        digest_0.6.30        xtable_1.8-4        
## [103] httpuv_1.6.8         RcppParallel_5.1.5   stats4_4.2.2        
## [106] munsell_0.5.0        bslib_0.4.2          shinyjs_2.1.0</code></pre>
</div>

    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/bayes/">Bayes</a>
  
  <a class="badge badge-light" href="/tags/simulation/">simulation</a>
  
  <a class="badge badge-light" href="/tags/distribution-theory/">distribution-theory</a>
  
  <a class="badge badge-light" href="/tags/generalized-linear-model/">generalized linear model</a>
  
  <a class="badge badge-light" href="/tags/programming/">programming</a>
  
  <a class="badge badge-light" href="/tags/rstats/">Rstats</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://www.jepusto.com/generalized-poisson-in-stan/&amp;text=Implementing%20Consul&amp;#39;s%20generalized%20Poisson%20distribution%20in%20Stan" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://www.jepusto.com/generalized-poisson-in-stan/&amp;t=Implementing%20Consul&amp;#39;s%20generalized%20Poisson%20distribution%20in%20Stan" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Implementing%20Consul&amp;#39;s%20generalized%20Poisson%20distribution%20in%20Stan&amp;body=https://www.jepusto.com/generalized-poisson-in-stan/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://www.jepusto.com/generalized-poisson-in-stan/&amp;title=Implementing%20Consul&amp;#39;s%20generalized%20Poisson%20distribution%20in%20Stan" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Implementing%20Consul&amp;#39;s%20generalized%20Poisson%20distribution%20in%20Stan%20https://www.jepusto.com/generalized-poisson-in-stan/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://www.jepusto.com/generalized-poisson-in-stan/&amp;title=Implementing%20Consul&amp;#39;s%20generalized%20Poisson%20distribution%20in%20Stan" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>








<section id="comments">
  
    
<div id="disqus_thread"></div>
<script>
  let disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); s.async = true;
    s.src = 'https://' + "jepusto" + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
</section>






  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/double-poisson-in-stan/">Implementing Efron&#39;s double Poisson distribution in Stan</a></li>
      
      <li><a href="/simulation-studies-in-r-2016/">Simulation studies in R (Fall, 2016 version)</a></li>
      
      <li><a href="/parallel-r-on-tacc-update/">Update: parallel R on the TACC</a></li>
      
      <li><a href="/parallel-r-on-tacc/">Running R in parallel on the TACC</a></li>
      
      <li><a href="/cluster-bootstrap-selection-model/">Cluster-Bootstrapping a meta-analytic selection model</a></li>
      
    </ul>
  </div>
  



  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    <script id="dsq-count-scr" src="https://jepusto.disqus.com/count.js" async></script>
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.37b744f7fa48882698912f536b972419.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  
  
  
   
  <script>
  $(document).ready(function () {
    window.initializeCodeFolding("show" === "show");
  });
  </script>
  <script src="/js/codefolding.js"></script>



  <p class="powered-by">
    © 2024 &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
